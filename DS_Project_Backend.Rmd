---
title: "DS_Project_Backend"
output: html_document
date: "2023-04-19"
---

```{r, include = TRUE, warning = FALSE, message = FALSE}
library(tidyverse)
library(modelr)
library(lubridate)
library(dplyr)
library(glmnet)
library(caret)
library(pROC)
library(caTools)
library(randomForest)


flight_new = read_csv("Flights Price Prediction Dataset\\Cleaned_dataset.csv", show_col_types = FALSE)
#head(flight_new)
unique(flight_new$Total_stops)
flight_new["Total_stops"][flight_new["Total_stops"]== "non-stop"] <- '0'
flight_new["Total_stops"][flight_new["Total_stops"]== "1-stop"] <- '1'
flight_new["Total_stops"][flight_new["Total_stops"]== "2+-stop"] <- '2'
flight_new$Total_stops = as.numeric(flight_new$Total_stops)
#head(flight_new)
```

##Model Fitting: Lasso Model to new data
```{r, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 3}
#Defining predictor and response variables
head(flight_new)
y = flight_new$Fare
x = model.matrix( ~ ., data =(select(flight_new,-Fare, -Flight_code, -Date_of_journey, -Duration_in_hours)))

#Splitting data
index = sample(nrow(x), floor(0.8 * nrow(x)))
x_train = x[index, ]
y_train = y[index]
x_test = x[-index, ]
y_test = y[-index]

#Fitting the model
model = cv.glmnet(x_train,y_train,alpha =1,folds = 5)
optimal_lambda = model$lambda.min
optimal_model = glmnet(x_train,y_train,alpha =1,lambda = optimal_lambda)
summary(optimal_model)

#Extracting model coefficients
coef(optimal_model)
```

```{r, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 3}
#Extracting pmodel predictions
predicted = predict(optimal_model, x_test)

#Evaluation metrics
auc(y_test, predicted)
postResample(y_test, predicted)

saveRDS(optimal_model, file = "model_file.rds")

```

```{r, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 3}

flightPricePredict <- function(Airline, Source, Destination, Flight_date, Days_left, Class, Total_stops, Arrival, Departure){
  flight_new = read_csv("Flights Price Prediction Dataset\\Cleaned_dataset.csv", show_col_types = FALSE)
  unique(flight_new$Total_stops)
  flight_new["Total_stops"][flight_new["Total_stops"]== "non-stop"] <- '0'
  flight_new["Total_stops"][flight_new["Total_stops"]== "1-stop"] <- '1'
  flight_new["Total_stops"][flight_new["Total_stops"]== "2+-stop"] <- '2'
  flight_new$Total_stops = as.numeric(flight_new$Total_stops)
  
  model <- readRDS("model_file.rds")
  Journey_day = strftime(Flight_date,"%A")
  flight_inpt = data.frame(Journey_day, Airline, Class, Source, Departure, Total_stops, Arrival, Destination, Days_left)
  inp = model.matrix( ~ ., data =rbind(flight_inpt, select(flight_new,-Fare, -Flight_code, -Date_of_journey, -Duration_in_hours)))
  prd = predict(model, inp[1, ])
  if(Days_left > 1){
    for i in 1:Days_left:
      print(i)
    prd = append(prd)
  }
  return(prd)
}

flightPricePredict("SpiceJet", "Delhi", "Mumbai", as.Date("12/02/22"), 5, "Economy", 0, "Before 6 AM", "6 AM - 12 PM") 
flightPricePredict("SpiceJet", "Delhi", "Mumbai", as.Date("12/02/22"), 4, "Economy", 0, "Before 6 AM", "6 AM - 12 PM") 
flightPricePredict("SpiceJet", "Delhi", "Mumbai", as.Date("12/02/22"), 3, "Economy", 0, "Before 6 AM", "6 AM - 12 PM") 
flightPricePredict("SpiceJet", "Delhi", "Mumbai", as.Date("12/02/22"), 2, "Economy", 0, "Before 6 AM", "6 AM - 12 PM") 
flightPricePredict("SpiceJet", "Delhi", "Mumbai", as.Date("12/02/22"), 1, "Economy", 0, "Before 6 AM", "6 AM - 12 PM") 


```